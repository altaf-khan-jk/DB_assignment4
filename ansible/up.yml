---
- name: Provision MySQL environment and run Flyway migrations
  hosts: localhost
  connection: local
  vars:
    mysql_root_password: "rootpassword"
    mysql_database: "subscribers_db"
    mysql_user: "app_user"
    mysql_password: "app_password"
    flyway_user: "flyway_user"
    flyway_password: "flyway_password"

  tasks:
    - name: Start MySQL container
      docker_container:
        name: mysql_db
        image: mysql:8.0
        state: started
        restart_policy: always
        env:
          MYSQL_ROOT_PASSWORD: "{{ mysql_root_password }}"
          MYSQL_DATABASE: "{{ mysql_database }}"
          MYSQL_USER: "{{ mysql_user }}"
          MYSQL_PASSWORD: "{{ mysql_password }}"
        ports:
          - "3306:3306"

    - name: Wait for MySQL to be ready
      wait_for:
        port: 3306
        host: 127.0.0.1
        delay: 10
        timeout: 60

    - name: Create Flyway user
      community.mysql.mysql_user:
        login_user: root
        login_password: "{{ mysql_root_password }}"
        login_host: 127.0.0.1
        name: "{{ flyway_user }}"
        password: "{{ flyway_password }}"
        priv: "{{ mysql_database }}.*:ALL"
        state: present

    - name: Run initial Flyway migrations
      command: >
        flyway -url=jdbc:mysql://127.0.0.1:3306/{{ mysql_database }}
        -user={{ flyway_user }} -password={{ flyway_password }}
        -locations=filesystem:../flyway/migrations_initial
        migrate
      args:
        chdir: flyway